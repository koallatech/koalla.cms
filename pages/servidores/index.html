<!DOCTYPE html>
<html lang="pt-br" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Servidores | Pandda</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/global.css">
    <head>
    <link rel="stylesheet" href="/assets/css/global.css">

    <script>
        (function() {
            const savedTheme = localStorage.getItem('pandda-theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
</head>
</head>
<body data-title="Gerenciar Servidores">
    <div id="loading-screen"><div style="border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div><p style="margin-top: 15px;">Carregando...</p></div>
    <div class="dashboard-container">
        <div id="sidebar-container"></div>
        <div class="main-content">
            <div id="topbar-container"></div>
            <main class="page-content">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <div><h3>Lista de Servidores</h3><p style="font-size: 13px;">Pontos de conexão.</p></div>
                        <button class="btn-primary" onclick="openModal()"><i class="material-icons-round">add</i> Novo Servidor</button>
                    </div>
                    <div class="table-container">
                        <table class="modern-table">
                            <thead><tr><th>Identificação</th><th>DNS Principal</th><th>DNS Secundário</th><th style="text-align: center;">Ativo?</th><th style="text-align: right;">Ações</th></tr></thead>
                            <tbody id="table-body"><tr><td colspan="5" style="text-align:center;">Carregando...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <div class="modal-overlay" id="server-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header"><h3 class="modal-title" id="modal-title">Novo Servidor</h3><button class="close-modal" onclick="closeModal()">&times;</button></div>
            <form id="server-form">
                <input type="hidden" id="server-id">
                <div class="form-group"><label>Nome Técnico</label><input type="text" id="nome" class="form-control" required></div>
                <div class="form-group"><label>Alias (Cliente)</label><input type="text" id="alias" class="form-control"></div>
                <div class="form-section-title">DNS 1</div>
                <div class="form-row"><div class="form-group"><label>Rótulo</label><input type="text" id="nome_dns1" class="form-control" value="Principal"></div><div class="form-group"><label>URL</label><input type="text" id="dns1" class="form-control" required></div></div>
                <div class="form-section-title">DNS 2</div>
                <div class="form-row"><div class="form-group"><label>Rótulo</label><input type="text" id="nome_dns2" class="form-control" value="Backup"></div><div class="form-group"><label>URL</label><input type="text" id="dns2" class="form-control"></div></div>
                <div class="form-actions"><button type="button" class="action-btn" onclick="closeModal()">Cancelar</button><button type="submit" class="btn-primary">Salvar</button></div>
            </form>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/assets/js/supabase-client.js"></script>
    <script src="/assets/js/components.js"></script>
    <script src="/assets/js/layout.js"></script>
    <script>
        const modal = document.getElementById('server-modal');
        const form = document.getElementById('server-form');
        async function fetchServidores() {
            const tbody = document.getElementById('table-body');
            const { data, error } = await window.supabaseClient.from('servidores').select('*').order('created_at', { ascending: false });
            if (error) return; tbody.innerHTML = '';
            data.forEach(s => {
                const alias = s.alias ? `<span style="font-size:11px; color:var(--sidebar-active);">★ ${s.alias}</span>` : '';
                const rowClass = s.ativo ? '' : 'class="row-disabled"';
                const toggle = `<label class="switch-sm"><input type="checkbox" ${s.ativo?'checked':''} onchange="toggleAtivo('${s.id}', this.checked)"><span class="slider-sm"></span></label>`;
                
                tbody.innerHTML += `<tr ${rowClass}><td><div style="font-weight:600;">${s.nome}</div>${alias}</td><td><strong style="font-size:12px;">${s.nome_dns1}:</strong><br><span style="font-size:12px;">${s.dns1}</span></td><td><strong style="font-size:12px;">${s.nome_dns2}:</strong><br><span style="font-size:12px;">${s.dns2||'-'}</span></td><td style="text-align:center;">${toggle}</td><td style="text-align:right;"><button class="action-btn" onclick="openModal('${s.id}')" style="color:#f59e0b;"><i class="material-icons-round">edit</i></button></td></tr>`;
            });
            document.getElementById('loading-screen').style.display = 'none';
        }
        window.openModal = async (id=null) => { modal.classList.add('open'); document.getElementById('server-id').value=''; form.reset(); if(id) { const { data } = await window.supabaseClient.from('servidores').select('*').eq('id', id).single(); if(data) { document.getElementById('server-id').value = data.id; document.getElementById('nome').value = data.nome; document.getElementById('alias').value = data.alias||''; document.getElementById('nome_dns1').value = data.nome_dns1; document.getElementById('dns1').value = data.dns1; document.getElementById('nome_dns2').value = data.nome_dns2||''; document.getElementById('dns2').value = data.dns2||''; } } }
        window.closeModal = () => modal.classList.remove('open');
        window.toggleAtivo = async (id, status) => { await window.supabaseClient.from('servidores').update({ativo: status}).eq('id', id); fetchServidores(); }
        form.addEventListener('submit', async (e) => { e.preventDefault(); const id = document.getElementById('server-id').value; const payload = { nome: document.getElementById('nome').value, alias: document.getElementById('alias').value, nome_dns1: document.getElementById('nome_dns1').value, dns1: document.getElementById('dns1').value, nome_dns2: document.getElementById('nome_dns2').value, dns2: document.getElementById('dns2').value }; await window.supabaseClient.from('servidores').upsert({ id: id||undefined, ...payload }); closeModal(); fetchServidores(); });
        window.onload = () => setTimeout(fetchServidores, 500);
    </script>
</body>
</html>