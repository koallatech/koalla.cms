<!DOCTYPE html>
<html lang="pt-br" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planos | Pandda</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/global.css">
</head>
<body>

    <div id="loading-screen">
        <div style="border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
        <p style="margin-top: 15px;">Carregando...</p>
    </div>

    <div class="dashboard-container">
        
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2><i class="material-icons-round logo-icon">grid_view</i><span>Pandda</span></h2>
            </div>
            <ul class="sidebar-menu">
                <li><a href="/pages/dashboard/index.html"><i class="material-icons-round">dashboard</i> <span>Dashboard</span></a></li>
                <li><a href="/pages/servidores/index.html"><i class="material-icons-round">dns</i> <span>Servidores</span></a></li>
                <li><a href="/pages/apps/index.html"><i class="material-icons-round">android</i> <span>Aplicativos</span></a></li>
                <li><a href="/pages/planos/index.html" class="active"><i class="material-icons-round">payments</i> <span>Planos</span></a></li>
                <li><a href="#"><i class="material-icons-round">people</i> <span>Clientes</span></a></li>
                <li><a href="#"><i class="material-icons-round">shopping_cart</i> <span>Assinaturas</span></a></li>
            </ul>
        </aside>

        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <div class="main-content">
            <header class="topbar">
                <div class="topbar-left">
                    <div class="toggle-btn" id="sidebar-toggle"><i class="material-icons-round">menu</i></div>
                    <h2 style="font-size: 18px; font-weight: 600; margin-left: 10px;">Gerenciar Planos</h2>
                </div>
                <div class="topbar-right">
                    <button class="action-btn" id="theme-toggle"><i class="material-icons-round" id="theme-icon">dark_mode</i></button>
                    <div style="width: 1px; height: 24px; background: var(--border-color);"></div>
                    <div class="user-info">
                        <div class="user-details"><span class="user-name">Admin</span></div>
                        <div class="user-avatar">A</div>
                    </div>
                    <button class="action-btn logout-btn" id="btn-logout"><i class="material-icons-round">logout</i></button>
                </div>
            </header>

            <main class="page-content">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <div>
                            <h3>Planos de Assinatura</h3>
                            <p style="font-size: 13px;">Defina preços e durações.</p>
                        </div>
                        <button class="btn-primary" onclick="openModal()">
                            <i class="material-icons-round">add</i> Novo Plano
                        </button>
                    </div>

                    <div class="table-container">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th>Nome do Plano</th>
                                    <th>Validade</th>
                                    <th>Preço Base</th>
                                    <th>Telas Inclusas</th>
                                    <th style="text-align: right;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="table-body">
                                <tr><td colspan="5" style="text-align:center;">Carregando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div class="modal-overlay" id="plano-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Novo Plano</h3>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            
            <form id="plano-form">
                <input type="hidden" id="plano-id">
                
                <div class="form-group">
                    <label>Nome do Plano</label>
                    <input type="text" id="nome" class="form-control" placeholder="Ex: Mensal 4K" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Validade (Meses)</label>
                        <input type="number" id="validade_meses" class="form-control" value="1" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>Preço (R$)</label>
                        <input type="number" id="preco" class="form-control" step="0.01" placeholder="0.00" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Telas Inclusas (Padrão)</label>
                    <input type="number" id="telas" class="form-control" value="1" min="1" required>
                    <small style="color: var(--text-secondary); font-size: 11px;">Quantidade base de conexões. Telas extras serão somadas a este valor na assinatura.</small>
                </div>

                <div class="form-group">
                    <label>Descrição (Opcional)</label>
                    <input type="text" id="descricao" class="form-control" placeholder="Ex: SD + HD + FHD">
                </div>

                <div class="form-actions">
                    <button type="button" class="action-btn" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar Plano</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/assets/js/supabase-client.js"></script>

    <script>
        // --- LAYOUT PADRÃO (Mesma lógica das outras pág) ---
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const html = document.documentElement;
        const savedTheme = localStorage.getItem('pandda-theme') || 'light';
        html.setAttribute('data-theme', savedTheme);
        if(themeIcon) themeIcon.innerText = savedTheme === 'light' ? 'dark_mode' : 'light_mode';

        if(themeToggle) {
            themeToggle.addEventListener('click', () => {
                const newTheme = html.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
                html.setAttribute('data-theme', newTheme);
                localStorage.setItem('pandda-theme', newTheme);
                themeIcon.innerText = newTheme === 'light' ? 'dark_mode' : 'light_mode';
            });
        }
        
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        if(sidebarToggle) {
            sidebarToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                if (window.innerWidth > 768) document.body.classList.toggle('collapsed');
                else { sidebar.classList.toggle('mobile-active'); overlay.classList.toggle('active'); }
            });
        }
        if(overlay) overlay.addEventListener('click', () => { sidebar.classList.remove('mobile-active'); overlay.classList.remove('active'); });
        
        const btnLogout = document.getElementById('btn-logout');
        if(btnLogout) btnLogout.addEventListener('click', async () => { if(confirm("Sair?")) { await window.supabaseClient.auth.signOut(); localStorage.removeItem('sb-yvktnznpozluqcjtvxeu-auth-token'); window.location.href='/pages/login/index.html'; }});

        // --- CRUD PLANOS ---
        const modal = document.getElementById('plano-modal');
        const form = document.getElementById('plano-form');

        // 1. LISTAR
        async function fetchPlanos() {
            const tbody = document.getElementById('table-body');
            const { data, error } = await window.supabaseClient
                .from('planos')
                .select('*')
                .order('preco', { ascending: true }); // Ordenar por preço

            if (error) { tbody.innerHTML = '<tr><td colspan="5">Erro...</td></tr>'; return; }
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px;">Nenhum plano cadastrado.</td></tr>';
                return;
            }

            data.forEach(plano => {
                const tr = document.createElement('tr');
                // Formatação de moeda BRL
                const precoFormatado = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(plano.preco);
                
                tr.innerHTML = `
                    <td>
                        <div style="font-weight:600;">${plano.nome}</div>
                        <small style="color:var(--text-secondary);">${plano.descricao || ''}</small>
                    </td>
                    <td>${plano.validade_meses} Mês(es)</td>
                    <td style="font-weight:600; color:var(--sidebar-active);">${precoFormatado}</td>
                    <td>${plano.telas} Tela(s)</td>
                    <td style="text-align: right;">
                        <button class="action-btn" onclick="openModal('${plano.id}')" style="color: #f59e0b;"><i class="material-icons-round">edit</i></button>
                        <button class="action-btn" onclick="deletePlano('${plano.id}')" style="color: #ef4444;"><i class="material-icons-round">delete</i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 2. MODAL
        window.openModal = async function(id = null) {
            modal.classList.add('open');
            document.getElementById('plano-id').value = '';
            form.reset();
            document.getElementById('modal-title').innerText = "Novo Plano";
            document.getElementById('validade_meses').value = 1;
            document.getElementById('telas').value = 1;

            if(id) loadPlanoData(id);
        }

        window.closeModal = function() { modal.classList.remove('open'); }

        // 3. SALVAR
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = form.querySelector('button[type="submit"]');
            btn.innerText = 'Salvando...'; btn.disabled = true;

            const id = document.getElementById('plano-id').value;
            
            const payload = {
                nome: document.getElementById('nome').value,
                validade_meses: document.getElementById('validade_meses').value,
                preco: document.getElementById('preco').value,
                telas: document.getElementById('telas').value,
                descricao: document.getElementById('descricao').value
            };

            let error;
            if(id) {
                const res = await window.supabaseClient.from('planos').update(payload).eq('id', id);
                error = res.error;
            } else {
                const res = await window.supabaseClient.from('planos').insert([payload]);
                error = res.error;
            }

            if(error) alert("Erro: " + error.message);
            else { closeModal(); fetchPlanos(); }
            btn.innerText = 'Salvar Plano'; btn.disabled = false;
        });

        // 4. CARREGAR
        async function loadPlanoData(id) {
            document.getElementById('modal-title').innerText = "Editar Plano";
            const { data } = await window.supabaseClient.from('planos').select('*').eq('id', id).single();
            if(data) {
                document.getElementById('plano-id').value = data.id;
                document.getElementById('nome').value = data.nome;
                document.getElementById('validade_meses').value = data.validade_meses;
                document.getElementById('preco').value = data.preco;
                document.getElementById('telas').value = data.telas;
                document.getElementById('descricao').value = data.descricao || '';
            }
        }

        // 5. DELETAR
        window.deletePlano = async function(id) {
            if(confirm("Excluir este plano?")) {
                await window.supabaseClient.from('planos').delete().eq('id', id);
                fetchPlanos();
            }
        }

        window.onload = () => { setTimeout(fetchPlanos, 500); };
    </script>
</body>
</html>