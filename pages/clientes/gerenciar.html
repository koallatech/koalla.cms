<!DOCTYPE html>
<html lang="pt-br" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Cliente | Pandda</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/global.css">
    
    <script>(function(){const s=localStorage.getItem('pandda-theme')||'light';document.documentElement.setAttribute('data-theme',s);})();</script>

    <style>
        .section-header { font-size: 14px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        
        /* Toggle e Sliders Específicos da Página */
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--sidebar-active); }
        input:checked + .slider:before { transform: translateX(24px); }
        
        .ponto-item { background: var(--bg-body); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>

<body data-title="Gerenciar Cliente">

    <div id="loading-screen"><div style="border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div><p style="margin-top: 15px;">Carregando...</p></div>

    <div class="dashboard-container">
        <div id="sidebar-container"></div>
        <div class="main-content">
            <div id="topbar-container"></div>
            <main class="page-content">
                
                <div style="margin-bottom: 20px;">
                    <a href="/pages/clientes/index.html" style="text-decoration: none; display: inline-flex; align-items: center; gap: 5px; font-weight: 500; color: var(--text-secondary); font-size: 14px;">
                        <i class="material-icons-round" style="font-size: 18px;">arrow_back</i> Voltar para Lista
                    </a>
                </div>

                <div class="manager-grid">
                    
                    <div class="left-col">
                        
                        <div class="card">
                            <div class="section-header">Dados Pessoais</div>
                            <form id="form-cliente">
                                <div class="form-group"><label>Nome</label><input type="text" id="cli-nome" class="form-control"></div>
                                <div class="form-group"><label>WhatsApp</label><input type="text" id="cli-zap" class="form-control"></div>
                                <div class="form-group"><label>Email</label><input type="text" id="cli-email" class="form-control"></div>
                                <div class="form-group"><label>Observações</label><textarea id="cli-obs" class="form-control" rows="2"></textarea></div>
                                
                                <button type="button" class="btn-secondary" style="margin-top:10px;" onclick="salvarDadosCliente()">
                                    <i class="material-icons-round">sync</i> Atualizar Dados
                                </button>
                            </form>
                        </div>

                        <div class="card" style="border-top: 4px solid var(--sidebar-active);">
                            <div class="section-header">Plano & Assinatura</div>
                            <div id="status-badge" style="margin-bottom:15px;"></div>

                            <form id="form-assinatura">
                                <input type="hidden" id="ass-id">
                                
                                <div class="form-group">
                                    <label>Plano</label>
                                    <select id="plano_id" class="form-control" onchange="aoMudarPlano()"><option value="">Selecione...</option></select>
                                </div>

                                <div class="form-row">
                                    <div class="form-group"><label>Telas Total</label><input type="number" id="telas_contratadas" class="form-control" min="1" value="1"></div>
                                    <div class="form-group"><label>Vencimento</label><input type="date" id="data_vencimento" class="form-control"></div>
                                </div>

                                <div class="form-group">
                                    <label>Servidor Principal</label>
                                    <select id="servidor_primario" class="form-control" onchange="travarSelectDual()">
                                        <option value="">Selecione...</option>
                                    </select>
                                </div>

                                <div style="margin-top:15px; padding-top:10px; border-top:1px dashed var(--border-color);">
                                    <div style="display:flex; align-items:center; gap:10px;">
                                        <label class="toggle-switch"><input type="checkbox" id="toggle-dualapp" onchange="toggleDualApp()"><span class="slider"></span></label>
                                        <span style="font-size:13px; font-weight:600;">Ativar DualAPP</span>
                                    </div>
                                    <div id="dual-area" style="display:none; margin-top:10px;">
                                        <label style="font-size:12px;">Servidor Secundário</label>
                                        <select id="servidor_secundario" class="form-control"><option value="">Selecione...</option></select>
                                    </div>
                                </div>

                                <div class="form-group" style="margin-top: 15px;">
                                    <label>Mensagem de Cobrança Personalizada (Opcional)</label>
                                    <textarea id="msg_personalizada" class="form-control" rows="3" placeholder="Deixe vazio para usar padrão."></textarea>
                                </div>

                                <div style="margin-top:20px;">
                                    <button type="button" class="btn-primary" style="width:100%;" onclick="salvarAssinatura()">
                                        <i class="material-icons-round">save</i> Salvar Contrato
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <div class="card">
                            <div id="area-bloqueio" style="text-align: center;">Carregando status...</div>
                        </div>
                    </div>

                    <div class="right-col">
                        <div class="card" id="card-pontos" style="opacity:0.5; pointer-events:none;">
                            <div class="section-header">Pontos de Acesso (Logins)</div>
                            
                            <div class="server-box primary">
                                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                                    <strong style="font-size:13px; color:var(--text-secondary);">SERVIDOR PRINCIPAL</strong>
                                    <span id="count-srv1" style="font-size:13px; font-weight:700;">0/0</span>
                                </div>
                                <div id="lista-srv1"></div>
                                <button class="btn-secondary" style="font-size:12px; padding:6px 12px; width:auto; margin-top:10px;" onclick="openModalPonto(1)">
                                    + Adicionar Ponto
                                </button>
                            </div>

                            <div id="block-srv2" class="server-box dual" style="display:none;">
                                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                                    <strong style="font-size:13px; color:var(--sidebar-active);">SERVIDOR DUAL</strong>
                                    <span id="count-srv2" style="font-size:13px; font-weight:700;">0/0</span>
                                </div>
                                <div id="lista-srv2"></div>
                                <button class="btn-secondary" style="font-size:12px; padding:6px 12px; width:auto; margin-top:10px; color:var(--sidebar-active);" onclick="openModalPonto(2)">
                                    + Adicionar Ponto Dual
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </main>
        </div>
    </div>

    <div class="modal-overlay" id="ponto-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="ponto-modal-title">Novo Ponto</h3>
                <button class="close-modal" onclick="closeModalPonto()">&times;</button>
            </div>
            <form id="ponto-form">
                <input type="hidden" id="ponto-target">
                
                <div class="form-group">
                    <label>Aplicativo</label>
                    <select id="ponto-app" class="form-control" required onchange="checkApp()">
                        <option value="">...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Tipo de Acesso</label>
                    <select id="ponto-tipo" class="form-control" onchange="toggleCred()">
                        <option value="login">Usuário e Senha</option>
                        <option value="mac">MAC Address</option>
                    </select>
                </div>
                
                <div id="area-login" class="form-row">
                    <div class="form-group"><input type="text" id="ponto-user" class="form-control" placeholder="Usuário"></div>
                    <div class="form-group"><input type="text" id="ponto-pass" class="form-control" placeholder="Senha"></div>
                </div>
                
                <div id="area-mac" style="display:none;">
                    <div class="form-group"><input type="text" id="ponto-mac" class="form-control" placeholder="MAC Address"></div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Telas</label>
                        <input type="number" id="ponto-telas" value="1" min="1" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Observação</label>
                        <input type="text" id="ponto-obs" class="form-control">
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Adicionar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/assets/js/supabase-client.js"></script>
    <script src="/assets/js/components.js"></script>
    <script src="/assets/js/layout.js"></script>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const clienteId = urlParams.get('id');

        let assinaturaAtual = null, planosCache = [], appsCache = [], servidoresCache = [];
        let pontosSrv1 = [], pontosSrv2 = [];
        let clienteAtual = null;

        window.onload = async () => {
            if(!clienteId) return window.location.href='/pages/clientes/index.html';
            
            // 1. Carregar Planos
            const { data: planos } = await window.supabaseClient.from('planos').select('*').eq('ativo', true);
            planosCache = planos;
            const selPlano = document.getElementById('plano_id');
            planos.forEach(p => selPlano.innerHTML += `<option value="${p.id}">${p.nome} (R$ ${p.preco})</option>`);

            // 2. Carregar Servidores (Cache)
            const { data: srvs } = await window.supabaseClient.from('servidores').select('*').eq('ativo', true);
            servidoresCache = srvs;
            atualizarSelectsServidores();

            // 3. Carregar Apps (Cache)
            const { data: apps } = await window.supabaseClient.from('apps').select('*').eq('ativo', true);
            appsCache = apps;

            // 4. Dados
            await carregarCliente();
            await carregarAssinatura();
        };

        // --- CLIENTE & BLOQUEIO ---
        async function carregarCliente() {
            const { data } = await window.supabaseClient.from('clientes').select('*').eq('id', clienteId).single();
            if(data) {
                clienteAtual = data;
                document.getElementById('cli-nome').value = data.nome;
                document.getElementById('cli-zap').value = data.whatsapp;
                document.getElementById('cli-email').value = data.email || '';
                document.getElementById('cli-obs').value = data.observacoes || '';
                renderBotaoBloqueio();
            }
        }

        function renderBotaoBloqueio() {
            const area = document.getElementById('area-bloqueio');
            if (clienteAtual.bloqueado) {
                area.innerHTML = `
                    <p style="font-size:12px; color:#666; margin-bottom:10px;">Cliente bloqueado.</p>
                    <button class="btn-unblock-user" onclick="toggleBloqueio(false)">
                        <i class="material-icons-round">lock_open</i> Desbloquear Acesso
                    </button>
                `;
            } else {
                area.innerHTML = `
                    <p style="font-size:12px; color:#666; margin-bottom:10px;">Impede o acesso, mantém os dados.</p>
                    <button class="btn-block-user" onclick="toggleBloqueio(true)">
                        <i class="material-icons-round">block</i> Bloquear Acesso
                    </button>
                `;
            }
        }

        async function toggleBloqueio(status) {
            if(confirm(status ? "Deseja BLOQUEAR este cliente?" : "Deseja DESBLOQUEAR este cliente?")) {
                await window.supabaseClient.from('clientes').update({ bloqueado: status }).eq('id', clienteId);
                carregarCliente();
            }
        }

        async function salvarDadosCliente() {
            const { error } = await window.supabaseClient.from('clientes').update({
                nome: document.getElementById('cli-nome').value,
                whatsapp: document.getElementById('cli-zap').value,
                email: document.getElementById('cli-email').value,
                observacoes: document.getElementById('cli-obs').value
            }).eq('id', clienteId);
            if(error) alert("Erro: " + error.message); else alert("Dados atualizados com sucesso!");
        }

        // --- ASSINATURA ---
        async function carregarAssinatura() {
            const { data } = await window.supabaseClient.from('assinaturas').select('*').eq('cliente_id', clienteId).single();
            const cardPontos = document.getElementById('card-pontos'), statusBadge = document.getElementById('status-badge');
            
            if(data) {
                assinaturaAtual = data;
                document.getElementById('ass-id').value = data.id;
                document.getElementById('plano_id').value = data.plano_id;
                document.getElementById('telas_contratadas').value = data.telas_contratadas;
                document.getElementById('data_vencimento').value = data.data_vencimento;
                
                // Set servers
                document.getElementById('servidor_primario').value = data.servidor_primario_id;
                
                // Set DualAPP
                document.getElementById('toggle-dualapp').checked = data.is_dual_app;
                toggleDualApp();
                if(data.is_dual_app) document.getElementById('servidor_secundario').value = data.servidor_secundario_id;
                
                // Mensagem Personalizada
                document.getElementById('msg_personalizada').value = data.mensagem_personalizada || '';

                travarSelectDual(); // Run validation

                const hoje = new Date().toISOString().split('T')[0];
                if(data.data_vencimento < hoje) statusBadge.innerHTML = '<span class="badge danger" style="font-size:14px;">CONTRATO VENCIDO</span>';
                else statusBadge.innerHTML = '<span class="badge success" style="font-size:14px;">CONTRATO ATIVO</span>';

                cardPontos.style.opacity = '1'; cardPontos.style.pointerEvents = 'auto';
                await carregarPontos(data.id);
            } else {
                statusBadge.innerHTML = '<span class="badge" style="background:#e2e8f0; color:#333;">SEM CONTRATO</span>';
                cardPontos.style.opacity = '0.5'; cardPontos.style.pointerEvents = 'none';
            }
            document.getElementById('loading-screen').style.display = 'none';
        }

        function atualizarSelectsServidores() {
            const sel1 = document.getElementById('servidor_primario');
            const sel2 = document.getElementById('servidor_secundario');
            sel1.innerHTML = '<option value="">Selecione...</option>';
            sel2.innerHTML = '<option value="">Selecione...</option>';
            servidoresCache.forEach(s => {
                const opt = `<option value="${s.id}">${s.nome} ${s.alias ? '('+s.alias+')' : ''}</option>`;
                sel1.innerHTML += opt; sel2.innerHTML += opt;
            });
        }

        // Impede selecionar mesmo servidor 2x
        window.travarSelectDual = function() {
            const val1 = document.getElementById('servidor_primario').value;
            const sel2 = document.getElementById('servidor_secundario');
            for(let i=0; i<sel2.options.length; i++) {
                if(sel2.options[i].value === val1 && val1 !== "") {
                    sel2.options[i].disabled = true;
                    sel2.options[i].style.color = "#ccc";
                    if(sel2.value === val1) sel2.value = "";
                } else {
                    sel2.options[i].disabled = false;
                    sel2.options[i].style.color = "var(--text-primary)";
                }
            }
        }

        function aoMudarPlano() {
            const plano = planosCache.find(p => p.id === document.getElementById('plano_id').value);
            if(plano) {
                document.getElementById('telas_contratadas').value = plano.telas;
                const h = new Date(); h.setMonth(h.getMonth() + plano.validade_meses);
                document.getElementById('data_vencimento').value = h.toISOString().split('T')[0];
            }
        }

        function toggleDualApp() {
            const chk = document.getElementById('toggle-dualapp').checked;
            document.getElementById('dual-area').style.display = chk ? 'block' : 'none';
            document.getElementById('block-srv2').style.display = chk ? 'block' : 'none';
        }

        async function salvarAssinatura() {
            const limit = parseInt(document.getElementById('telas_contratadas').value);
            const uso1 = pontosSrv1.reduce((a,b)=>a+b.telas_ocupadas,0), uso2 = pontosSrv2.reduce((a,b)=>a+b.telas_ocupadas,0);
            
            if(uso1 > limit) return alert(`Srv1 excede limite (${uso1}/${limit}).`);
            if(document.getElementById('toggle-dualapp').checked && uso2 > limit) return alert(`Srv2 excede limite (${uso2}/${limit}).`);

            const payload = {
                cliente_id: clienteId,
                plano_id: document.getElementById('plano_id').value,
                telas_contratadas: limit,
                data_vencimento: document.getElementById('data_vencimento').value,
                servidor_primario_id: document.getElementById('servidor_primario').value,
                is_dual_app: document.getElementById('toggle-dualapp').checked,
                servidor_secundario_id: document.getElementById('toggle-dualapp').checked ? document.getElementById('servidor_secundario').value : null,
                mensagem_personalizada: document.getElementById('msg_personalizada').value
            };

            const { error } = await window.supabaseClient.from('assinaturas').upsert({ id: assinaturaAtual?.id, ...payload });
            if(error) alert("Erro: " + error.message); else { alert("Contrato salvo!"); carregarAssinatura(); }
        }

        // --- PONTOS & MODAL INTELIGENTE ---
        async function carregarPontos(assId) {
            const { data } = await window.supabaseClient.from('pontos_acesso').select('*, apps(nome)').eq('assinatura_id', assId);
            pontosSrv1 = []; pontosSrv2 = [];
            const srv1 = document.getElementById('servidor_primario').value;
            const srv2 = document.getElementById('servidor_secundario').value;
            
            data.forEach(p => {
                if(p.servidor_id === srv1) pontosSrv1.push(p);
                else if(p.servidor_id === srv2) pontosSrv2.push(p);
                else pontosSrv1.push(p);
            });
            renderLista('lista-srv1', pontosSrv1, 'count-srv1'); 
            renderLista('lista-srv2', pontosSrv2, 'count-srv2');
        }

        function renderLista(divId, lista, countId) {
            const limit = parseInt(document.getElementById('telas_contratadas').value);
            const used = lista.reduce((a,b)=>a+b.telas_ocupadas,0);
            document.getElementById(countId).innerText = `${used} / ${limit}`;
            document.getElementById(countId).style.color = used > limit ? 'red' : 'green';
            
            document.getElementById(divId).innerHTML = lista.map(p => `
                <div class="ponto-item">
                    <div>
                        <div style="font-weight:600; font-size:13px;">${p.apps?.nome} (${p.telas_ocupadas}t)</div>
                        <div style="font-size:12px; color:#666;">${p.tipo_acesso==='login'?p.usuario:p.mac_address}</div>
                    </div>
                    <button class="btn-sm btn-danger" onclick="delPonto('${p.id}')"><i class="material-icons-round">delete</i></button>
                </div>
            `).join('');
        }

        const modalPonto = document.getElementById('ponto-modal');
        
        window.openModalPonto = function(target) {
            const limit = parseInt(document.getElementById('telas_contratadas').value);
            const lista = target===1 ? pontosSrv1 : pontosSrv2;
            const used = lista.reduce((a,b)=>a+b.telas_ocupadas,0);
            if(used >= limit) return alert("Limite de telas atingido neste servidor.");

            // Identificar Servidor e Apps Compatíveis
            const srvId = target===1 ? document.getElementById('servidor_primario').value : document.getElementById('servidor_secundario').value;
            const srvObj = servidoresCache.find(s => s.id === srvId);
            document.getElementById('ponto-modal-title').innerText = `Novo Ponto: ${srvObj ? srvObj.nome : 'Servidor'}`;

            const selApp = document.getElementById('ponto-app');
            selApp.innerHTML = '<option value="">Selecione...</option>';
            const appsFiltrados = appsCache.filter(a => a.servidor_id === srvId);
            
            if(appsFiltrados.length === 0) selApp.innerHTML = '<option value="">Nenhum app disponível</option>';
            else appsFiltrados.forEach(a => selApp.innerHTML += `<option value="${a.id}">${a.nome}</option>`);

            document.getElementById('ponto-target').value = target;
            modalPonto.classList.add('open');
            document.getElementById('ponto-form').reset();
            toggleCred();
        }

        function closeModalPonto() { modalPonto.classList.remove('open'); }
        function toggleCred() { const t = document.getElementById('ponto-tipo').value; document.getElementById('area-login').style.display = t==='login'?'grid':'none'; document.getElementById('area-mac').style.display = t==='mac'?'block':'none'; }
        function checkApp() { const aid = document.getElementById('ponto-app').value, app = appsCache.find(a => a.id === aid), ipt = document.getElementById('ponto-telas'); if(app && !app.permite_multitela) { ipt.value = 1; ipt.disabled = true; } else { ipt.disabled = false; } }

        document.getElementById('ponto-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const target = parseInt(document.getElementById('ponto-target').value);
            const limit = parseInt(document.getElementById('telas_contratadas').value);
            const lista = target===1 ? pontosSrv1 : pontosSrv2;
            const novas = parseInt(document.getElementById('ponto-telas').value);
            const used = lista.reduce((a,b)=>a+b.telas_ocupadas,0);

            if(used + novas > limit) return alert("Limite excedido.");

            const srvId = target===1 ? document.getElementById('servidor_primario').value : document.getElementById('servidor_secundario').value;
            const { error } = await window.supabaseClient.from('pontos_acesso').insert([{
                assinatura_id: assinaturaAtual.id,
                servidor_id: srvId,
                app_id: document.getElementById('ponto-app').value,
                tipo_acesso: document.getElementById('ponto-tipo').value,
                usuario: document.getElementById('ponto-user').value,
                senha: document.getElementById('ponto-pass').value,
                mac_address: document.getElementById('ponto-mac').value,
                telas_ocupadas: novas,
                observacao: document.getElementById('ponto-obs').value
            }]);
            if(error) alert(error.message); else { closeModalPonto(); carregarPontos(assinaturaAtual.id); }
        });

        async function delPonto(id) { if(confirm("Excluir?")) { await window.supabaseClient.from('pontos_acesso').delete().eq('id', id); carregarPontos(assinaturaAtual.id); } }
    </script>
</body>
</html>